<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CDN Example - MapLibre GL Components</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.15.0/dist/maplibre-gl.css" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl-components@0.6.0/dist/maplibre-gl-components.css" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl-layer-control/dist/maplibre-gl-layer-control.css" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      /* Ensure layer control is clickable */
      .maplibregl-ctrl-top-left {
        z-index: 1;
      }
      .layer-control-container {
        pointer-events: auto;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script type="module">
      import maplibregl from 'https://esm.sh/maplibre-gl@5.15.0';
      import { BasemapControl } from 'https://esm.sh/maplibre-gl-components@0.6.0';
      import { LayerControl } from 'https://esm.sh/maplibre-gl-layer-control@0.11.0';

      // Initialize the map with CartoDB Positron basemap
      const map = new maplibregl.Map({
        container: 'map',
        style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
        center: [0, 20],
        zoom: 2
      });

      map.on('load', async () => {


        // Add navigation control
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        map.addControl(new maplibregl.GlobeControl(), 'top-right');

        // Add basemap control - fetches from xyzservices by default
        const basemapControl = new BasemapControl({
          showSearch: true,
          collapsible: true,
          displayMode: 'dropdown',
          filterGroups: ['OpenStreetMap', 'CartoDB', 'OpenTopoMap', 'Esri', 'Google'],
          excludeBroken: true,
          maxHeight: 400,
        });
        map.addControl(basemapControl, 'top-right');

        // Keep airports layer on top when basemap changes
        basemapControl.on('basemapchange', () => {
          if (map.getLayer('airports-layer')) {
            map.moveLayer('airports-layer');
          }
        });

        // Load airports GeoJSON (Natural Earth data with CORS support)
        const geojsonUrl = 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_10m_airports.geojson';

        try {
          const response = await fetch(geojsonUrl);
          const geojson = await response.json();

          // Add airports source
          map.addSource('airports', {
            type: 'geojson',
            data: geojson
          });

          // Add airports layer as circles
          map.addLayer({
            id: 'airports-layer',
            type: 'circle',
            source: 'airports',
            paint: {
              'circle-radius': [
                'interpolate',
                ['linear'],
                ['zoom'],
                2, 3,
                6, 5,
                10, 8
              ],
              'circle-color': '#667eea',
              'circle-stroke-color': '#fff',
              'circle-stroke-width': 1,
              'circle-opacity': 0.8
            }
          });

          // Add layer control
          map.addControl(new LayerControl({
            collapsed: true,
            showOpacitySlider: true,
            showLayerSymbol: true,
            basemapStyleUrl: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json'
          }), 'top-right');

          // Add popup on click
          map.on('click', 'airports-layer', (e) => {
            if (e.features && e.features.length > 0) {
              const feature = e.features[0];
              const props = feature.properties;
              const coordinates = e.lngLat;

              const popupHtml = `
                <div style="font-family: sans-serif; font-size: 14px;">
                  <strong style="font-size: 16px;">${props.name || 'Unknown Airport'}</strong>
                  ${props.iata_code ? `<div style="color: #667eea; font-weight: 600;">${props.iata_code}</div>` : ''}
                  ${props.location ? `<div style="color: #666; margin-top: 4px;">${props.location}</div>` : ''}
                  ${props.type ? `<div style="color: #888;">${props.type}</div>` : ''}
                </div>
              `;

              new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML(popupHtml)
                .addTo(map);
            }
          });

          // Change cursor on hover
          map.on('mouseenter', 'airports-layer', () => {
            map.getCanvas().style.cursor = 'pointer';
          });

          map.on('mouseleave', 'airports-layer', () => {
            map.getCanvas().style.cursor = '';
          });

        } catch (error) {
          console.error('Error loading airports data:', error);
        }
      });
    </script>
  </body>
</html>
